{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-reader.js"],"names":["fs","require","EventEmitter","Stream","unzip","Sax","tmp","FlowControl","StyleManager","WorkbookPropertiesManager","WorksheetReader","HyperlinkReader","setGracefulCleanup","WorkbookReader","options","styles","init","properties","worksheetReaders","hyperlinkReaders","readers","atEnd","waitingWorkSheets","tempFileCleanupCallbacks","input","Readable","createReadStream","Error","stream","_getStream","zip","Parse","pendingWorksheetsTmpFiles","on","entry","match","sheetNo","path","autodrain","_parseWorkbook","_parseSharedStrings","_parseStyles","sharedStrings","_parseWorksheet","push","Promise","resolve","reject","file","err","fd","cleanupCallback","tempStream","createWriteStream","pipe","_parseHyperlinks","all","emit","length","currentBook","processBooks","worksheetInfo","worksheet","forEach","cb","setImmediate","payload","entries","_emitEntry","type","parseStream","parser","createStream","inT","t","index","node","name","text","error","Type","collection","reader","id","worksheetReader","_getReader","worksheets","read","hyperlinksReader","hyperlinks","_flowControl","Options","module","exports"],"mappings":"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","sourcesContent":["const fs = require('fs');\nconst {EventEmitter} = require('events');\nconst Stream = require('stream');\nconst unzip = require('unzipper');\nconst Sax = require('sax');\nconst tmp = require('tmp');\n\nconst FlowControl = require('../../utils/flow-control');\n\nconst StyleManager = require('../../xlsx/xform/style/styles-xform');\nconst WorkbookPropertiesManager = require('../../xlsx/xform/book/workbook-properties-xform');\n\nconst WorksheetReader = require('./worksheet-reader');\nconst HyperlinkReader = require('./hyperlink-reader');\n\ntmp.setGracefulCleanup();\n\nclass WorkbookReader extends EventEmitter {\n  constructor(options) {\n    super();\n\n    this.options = options = options || {};\n\n    this.styles = new StyleManager();\n    this.styles.init();\n\n    this.properties = new WorkbookPropertiesManager();\n\n    // worksheet readers, indexed by sheetNo\n    this.worksheetReaders = {};\n\n    // hyperlink readers, indexed by sheetNo\n    this.hyperlinkReaders = {};\n\n    // count the open readers\n    this.readers = 0;\n\n    // end of stream check\n    this.atEnd = false;\n\n    // worksheets, deferred for parsing after shared strings reading\n    this.waitingWorkSheets = [];\n\n    // callbacks for temp files cleanup\n    this.tempFileCleanupCallbacks = [];\n  }\n\n  _getStream(input) {\n    if (input instanceof Stream.Readable) {\n      return input;\n    }\n    if (typeof input === 'string') {\n      return fs.createReadStream(input);\n    }\n    throw new Error('Could not recognise input');\n  }\n\n  get flowControl() {\n    if (!this._flowControl) {\n      this._flowControl = new FlowControl(this.options);\n    }\n    return this._flowControl;\n  }\n\n  read(input, options) {\n    const stream = (this.stream = this._getStream(input));\n    const zip = (this.zip = unzip.Parse());\n    const pendingWorksheetsTmpFiles = [];\n\n    zip.on('entry', entry => {\n      let match;\n      let sheetNo;\n      switch (entry.path) {\n        case '_rels/.rels':\n        case 'xl/_rels/workbook.xml.rels':\n          entry.autodrain();\n          break;\n        case 'xl/workbook.xml':\n          this._parseWorkbook(entry, options);\n          break;\n        case 'xl/sharedStrings.xml':\n          this._parseSharedStrings(entry, options);\n          break;\n        case 'xl/styles.xml':\n          this._parseStyles(entry, options);\n          break;\n        default:\n          if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\n            match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\n            sheetNo = match[1];\n            if (this.sharedStrings) {\n              this._parseWorksheet(entry, sheetNo, options);\n            } else {\n              // create temp file for each worksheet\n              pendingWorksheetsTmpFiles.push(\n                new Promise((resolve, reject) => {\n                  tmp.file((err, path, fd, cleanupCallback) => {\n                    if (err) {\n                      return reject(err);\n                    }\n\n                    const tempStream = fs.createWriteStream(path);\n\n                    this.waitingWorkSheets.push({sheetNo, options, path});\n                    entry.pipe(tempStream);\n\n                    this.tempFileCleanupCallbacks.push(cleanupCallback);\n\n                    return tempStream.on('finish', () => {\n                      return resolve();\n                    });\n                  });\n                })\n              );\n            }\n          } else if (entry.path.match(/xl\\/worksheets\\/_rels\\/sheet\\d+[.]xml.rels/)) {\n            match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\n            sheetNo = match[1];\n            this._parseHyperlinks(entry, sheetNo, options);\n          } else {\n            entry.autodrain();\n          }\n          break;\n      }\n    });\n\n    zip.on('close', async () => {\n      try {\n        await Promise.all(pendingWorksheetsTmpFiles);\n      } catch (err) {\n        this.emit('error', err);\n        return;\n      }\n\n      if (this.waitingWorkSheets.length) {\n        let currentBook = 0;\n\n        const processBooks = () => {\n          const worksheetInfo = this.waitingWorkSheets[currentBook];\n          const entry = fs.createReadStream(worksheetInfo.path);\n\n          const {sheetNo} = worksheetInfo;\n          const worksheet = this._parseWorksheet(\n            entry,\n            sheetNo,\n            worksheetInfo.options\n          );\n\n          worksheet.on('finished', () => {\n            ++currentBook;\n            if (currentBook === this.waitingWorkSheets.length) {\n              // temp files cleaning up\n              this.tempFileCleanupCallbacks.forEach(cb => {\n                cb();\n              });\n\n              this.tempFileCleanupCallbacks = [];\n\n              this.emit('end');\n              this.atEnd = true;\n              if (!this.readers) {\n                this.emit('finished');\n              }\n            } else {\n              setImmediate(processBooks);\n            }\n          });\n        };\n        setImmediate(processBooks);\n      } else {\n        this.emit('end');\n        this.atEnd = true;\n        if (!this.readers) {\n          this.emit('finished');\n        }\n      }\n    });\n\n    zip.on('error', err => {\n      this.emit('error', err);\n    });\n\n    // Pipe stream into top flow-control\n    // this.flowControl.pipe(zip);\n    stream.pipe(zip);\n  }\n\n  _emitEntry(options, payload) {\n    if (options.entries === 'emit') {\n      this.emit('entry', payload);\n    }\n  }\n\n  _parseWorkbook(entry, options) {\n    this._emitEntry(options, {type: 'workbook'});\n    this.properties.parseStream(entry);\n  }\n\n  _parseSharedStrings(entry, options) {\n    this._emitEntry(options, {type: 'shared-strings'});\n    let sharedStrings = null;\n    switch (options.sharedStrings) {\n      case 'cache':\n        sharedStrings = this.sharedStrings = [];\n        break;\n      case 'emit':\n        break;\n      default:\n        entry.autodrain();\n        return;\n    }\n\n    const parser = Sax.createStream(true, {});\n    let inT = false;\n    let t = null;\n    let index = 0;\n    parser.on('opentag', node => {\n      if (node.name === 't') {\n        t = null;\n        inT = true;\n      }\n    });\n    parser.on('closetag', name => {\n      if (inT && name === 't') {\n        if (sharedStrings) {\n          sharedStrings.push(t);\n        } else {\n          this.emit('shared-string', {index: index++, text: t});\n        }\n        t = null;\n      }\n    });\n    parser.on('text', text => {\n      t = t ? t + text : text;\n    });\n    parser.on('error', error => {\n      this.emit('error', error);\n    });\n    entry.pipe(parser);\n  }\n\n  _parseStyles(entry, options) {\n    this._emitEntry(options, {type: 'styles'});\n    if (options.styles !== 'cache') {\n      entry.autodrain();\n      return;\n    }\n    this.styles = new StyleManager();\n    this.styles.parseStream(entry);\n  }\n\n  _getReader(Type, collection, sheetNo) {\n    let reader = collection[sheetNo];\n    if (!reader) {\n      reader = new Type(this, sheetNo);\n      this.readers++;\n      reader.on('finished', () => {\n        if (!--this.readers) {\n          if (this.atEnd) {\n            this.emit('finished');\n          }\n        }\n      });\n      collection[sheetNo] = reader;\n    }\n    return reader;\n  }\n\n  _parseWorksheet(entry, sheetNo, options) {\n    this._emitEntry(options, {type: 'worksheet', id: sheetNo});\n    const worksheetReader = this._getReader(WorksheetReader, this.worksheetReaders, sheetNo);\n    if (options.worksheets === 'emit') {\n      this.emit('worksheet', worksheetReader);\n    }\n    worksheetReader.read(entry, options, this.hyperlinkReaders[sheetNo]);\n    return worksheetReader;\n  }\n\n  _parseHyperlinks(entry, sheetNo, options) {\n    this._emitEntry(options, {type: 'hyerlinks', id: sheetNo});\n    const hyperlinksReader = this._getReader(HyperlinkReader, this.hyperlinkReaders, sheetNo);\n    if (options.hyperlinks === 'emit') {\n      this.emit('hyperlinks', hyperlinksReader);\n    }\n    hyperlinksReader.read(entry, options);\n  }\n}\n\n// for reference - these are the valid values for options\nWorkbookReader.Options = {\n  entries: ['emit'],\n  sharedStrings: ['cache', 'emit'],\n  styles: ['cache'],\n  hyperlinks: ['cache', 'emit'],\n  worksheets: ['emit'],\n};\n\n\nmodule.exports = WorkbookReader;\n"],"file":"workbook-reader.js"}